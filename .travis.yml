sudo: required

services:
    - docker

before_install:
    - docker pull tgrogers/gpgpu-sim_regress:firsttry

language: cpp

script: docker run -v `pwd`:/home/runner/gpgpu-sim_distribution:rw tgrogers/gpgpu-sim_regress:firsttry /bin/bash -c "wget http://archive.ubuntu.com/ubuntu/pool/universe/t/torque/torque_2.4.16+dfsg.orig.tar.gz && tar xzvf torque_2.4.16+dfsg.orig.tar.gz && cd torque-2.4.16/ && ./configure --disable-posixmemlock && make && cp ./src/resmom/.libs/pbs_mom /usr/sbin/ && echo \"\\\$loglevel 7\" >> /var/spool/torque/mom_priv/config; cd /gpgpu-sim/ && ./start_torque.sh; ps -aux | grep -i pbs; while true; do cat /var/spool/torque/mom_logs/\`ls -rt /var/spool/torque/mom_logs | tail -1\`; ps -aux | grep -i pbs; done"
#script: docker run -v `pwd`:/home/runner/gpgpu-sim_distribution:rw tgrogers/gpgpu-sim_regress:firsttry /bin/bash -c "echo \"\\\$loglevel 7\" >> /var/spool/torque/mom_priv/config; ./start_torque.sh; ps -aux | grep -i pbs; cat /etc/hosts ;chown -R runner /home/runner/gpgpu-sim_distribution; echo \"mom_2\" && /etc/init.d/torque-mom restart && ps -aux | grep -i pbs && su - runner -c 'source /home/runner/gpgpu-sim_distribution/setup_environment && make -j -C /home/runner/gpgpu-sim_distribution && cd /home/runner/gpgpu-sim_simulations/ && git pull && /home/runner/gpgpu-sim_simulations/util/job_launching/run_simulations.py -N regress && while true; do lscpu; cat /var/spool/torque/server_logs/\`ls /var/spool/torque/server_logs\`; echo \"mom_logs\"; cat /var/spool/torque/mom_logs/\`ls /var/spool/torque/mom_logs\`; ps -aux | grep -i pbs; done'"
